{% extends 'main/general.html' %}

{% block title %} Monthly Calendar {% endblock %}

{% block css %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'styles/main/calendarstyles.css' %}">
{% endblock %}

{% block maincontent %}
<div class="main">
    <h2>{{ month_name }} {{ year_name }}</h2>
    <table class="cal" border="0">
        <tr>
            <th>Monday</th>
            <th>Tuesday</th>
            <th>Wednesday</th>
            <th>Thursday</th>
            <th>Friday</th>
            <th>Saturday</th>
            <th>Sunday</th>
        </tr>
        {% for week in calendar %}
            <tr>
            {% for day in week %}
                <td>
                    {{ day }}
                    <ul>
                        {% for event in events %}
                            {% if event.date.day == day %}
                                <li>
                                    <strong>Title:</strong> {{ event.title }}<br>
                                    <strong>Time:</strong> {{ event.start_time }} - {{ event.end_time }}<br>
                                    <strong>Location:</strong> {{ event.location }}<br>
                                    <strong>Description:</strong> {{ event.description }}<br>
                                    <strong>Creator:</strong> {{ event.creator_nickname }}<br>
                                    <strong>Invited Users:</strong> {{ event.invited_users_nicknames|join:", " }}<br>
                                    {% if event.recurrence %}
                                        <strong>Recurrence:</strong> {{ event.recurrence }}<br>
                                    {% endif %}
                                        <button onclick="deleteEvent({{ event.title }})">Delete</button>

                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </td>
            {% endfor %}
            </tr>
        {% endfor %}
    </table>

    <a class="button1" href="/calendar/{{ prev_month }}"><span style='font-size:20px;'>&#9204;</span></a>
    <a class="button1" href="/calendar/{{ next_month }}"><span style='font-size:20px;'>&#9205;</span></a>
</div>

<form id="event-form">
    {% csrf_token %}
    <label for="event_title">Title:</label><br>
    <input type="text" id="event_title" name="event_title"><br>
    <label for="event_date">Date:</label><br>
    <input type="date" id="event_date" name="event_date"><br>
    <label for="start_time">Start Time:</label><br>
    <input type="time" id="start_time" name="start_time"><br>
    <label for="end_time">End Time:</label><br>
    <input type="time" id="end_time" name="end_time"><br>

    <label for="recurrence">Recurrence:</label><br>
    <select id="recurrence" name="recurrence">
        <option value="">None</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
    </select><br>

    <label for="event_location">Location:</label><br>
    <input type="text" id="event_location" name="event_location"><br>
    <label for="event_description">Description:</label><br>
    <textarea id="event_description" name="event_description"></textarea><br>
    <label for="invited_emails">Invite others (comma-separated email addresses):</label><br>
    <input type="text" id="invited_emails" name="invited_emails"><br>
    <button type="submit">Create Event</button>
</form>
{% endblock maincontent %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("event-form").addEventListener("submit", function(event) {
        event.preventDefault();
        var formData = new FormData(this);
        fetch('/create_event/', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert("Event created successfully!");
            } else {
                alert("Failed to create event. Please try again.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("An unexpected error occurred.");
        });
    });
});

function deleteEvent(eventTitle) {
    fetch(`/delete_event/${encodeURIComponent(eventTitle)}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),  // Ensure to include CSRF token
        }
    })
    .then(response => {
        if (response.ok) {
            alert("Event deleted successfully!");
            // Optionally, you can remove the event from the UI without reloading the page
        } else {
            alert("Failed to delete event. Please try again.");
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert("An unexpected error occurred.");
    });
}

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


</script>
{% endblock %}


